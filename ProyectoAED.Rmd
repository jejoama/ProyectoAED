---
title: Evolución de la actividad, ocupación para grupos de edad mayores de 16 años
author:
  - name: Jeremy Joel Aguilar Marin
  - name: Jose Aguilar Milla
  - name: Javier Herrero Pérez

journal: notspecified 
type: article
status: submit
# front matter
simplesummary: |
  A Simple summary goes here.
abstract: |


keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).
# back matter

bibliography: mybibfile.bib
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable

---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  message = FALSE,     # Oculta mensajes de carga (por ejemplo, de librerías)
  warning = FALSE     # Oculta advertencias
)
```



```{r,echo = FALSE}
rm(list=ls())
```


```{r,echo = FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  readr,
  dplyr,
  tidyr,
  stringr,
  forcats,
  ggplot2,
  visdat,
  treemapify,
  gganimate,
  gifski
)
```


# Introducción
Este artículo presenta un enfoque en R para el Análisis Exploratorio de Datos de la Encuesta de Población Activa (EPA), centrándose en la evolución histórica de la brecha de género en el mercado laboral español. Utilizando el ecosistema `tidyverse`, el estudio comienza con una limpieza y transformación de los datos empleando `dplyr` y el cálculo de Tasa de paro, actividad y ocupación, claves para el análisis. Seguido de la visualización con `ggplot2` para ilustrar la evolución temporal. Por último, se validan los resultados con pruebas de *t Student* para confirmar la significancia estadística de los resutlados.


# Exploración inicial

## Importación y verificación inicial

- **Codificación e importación**: La codificación del los datos brutos es `UFT-8` con una confianza del $100\%$. Archivo delimitado por tabulaciones, se indica que el separador decimal es la coma y que los valores *NA* están codificados como `".."`.

```{r,echo = FALSE}
df<-read_delim("data/65948.csv", delim = "\t", escape_double = FALSE, na = "..", 
               trim_ws = TRUE,locale = locale(decimal_mark = ","))
```

Las variables del dataframe original son: Sexo, Edad, Relación con la actividad económica, Periodo y Total.

## Valores faltantes

Los valores ausentes se encuentran concentrados `Total`

```{r,echo = FALSE}
df %>% rename(Situacion_Laboral = "Relación con la actividad económica") %>% filter(is.na(Total)) %>% ggplot(aes(x=Situacion_Laboral))+geom_bar(aes(fill=Edad))+labs(
    title = "Frecuencia de los registros faltantes NA",
    subtitle = "Distribución por Situación Laboral y la edad",
    y = "Valores faltantes", # Quitamos la etiqueta redundante del eje Y
    x = "Número de Registros con NA"
  ) +
  theme_minimal()
```

Se observa que los valores faltantes vienen asociados a grupos de edad altos y cuya relación con la actividad económica es "Parados que buscan primer empleo" o "Parados".


# Definición de variables

El valor de la columna **Total** viene definido con la siguiente expresión:

$$\text{Total}=\text{Activos}+\text{Inactivos}$$
Y los **Activos** se dividen en Ocupados y Parados:

$$\text{Activos}=\text{Ocupados}+\text{Parados}$$
## Fórmulas para el análisis (Tasas)

Las tasas permiten normalizar los datos y son la base para el análisis de brechas y series temporales:



La **tasa de paro** mide la proporción de la población activa que está desempleada:

$$\text{Tasa de paro}=\frac{\text{Parados}}{\text{Activos}} \cdot 100$$

La **tasa de actividad** mide la participación de una población en el mercado laboral:

$$\text{Tasa de actividad}=\frac{\text{Activos}}{\text{Total}} \cdot 100$$
La **tasa de ocupación** muestra qué parte de la población total de referencia tiene un empleo:

$$\text{Tasa de ocupación}=\frac{\text{Ocupados}}{\text{Total}} \cdot 100$$

# Limpieza

- **Renombrar columnas**: Utilizando `rename()` para acortar `"Relación con la actividad económica"` por ` "Situacion_Laboral"` para simplificar el manejo de columnas.

- **Filtrado de doble conteo**: Se eliminan las instancias donde las variables representan la suma de otras instancias (`Sexo="Ambos sexos"` y `Edad="Total"`) para evitar doble conteo y así verificar que cada registro sea una observación única.

- **Se aplica `pivot_wider()`** utilizando los valores de la columna `Situacion_Laboral` para crear las nuevas columnas (`names_from`) y los valores numéricos de la columna `Total`.

- **Renombrar variables**: Se renombra la columna `"parados que buscan primer empleo"` a un formato más corto `r "Parados_sin_exp"`

- **Imputación de NA a 0**: Los valores faltantes se concentran en categorías como Personas mayores de 65 en paro o que buscan su primer empleo. El INE suprime el dato por ser un valor insignificante, por lo que se opta por remplazar los valores nulos a 0 para no perder el resto de información válida de la instancia.

- **Creación de tasas**: Se añaden las columnas `Tasa_paro`, `Tasa_actividad` y `Tasa_ocupacion` utilizando `mutate()` y las expresiones de la EPA.

- **Ordenación en factores**: Se ordena la columna `Edad` como un factor ordinal y la columna `Sexo` como factor nominal.

```{r,echo = FALSE}
df_clean<-df %>% 
  rename(Situacion_Laboral = "Relación con la actividad económica") %>% 
  filter(Sexo != "Ambos sexos", Edad != "Total") %>% 
  mutate(Sexo=as.factor(Sexo), Edad=as.factor(Edad),
         Situacion_Laboral=as.factor(Situacion_Laboral)) %>%
  pivot_wider(names_from = Situacion_Laboral,values_from = Total) %>% 
  rename(Parados_sin_exp="Parados que buscan primer empleo") %>% 
  mutate(across(.cols=c(Parados,Parados_sin_exp,Activos,Ocupados,Inactivos),
                .fns=~replace_na(.,0))) %>% 
  mutate(across(c(Activos, Ocupados, Parados, Inactivos, Total), as.numeric),Tasa_paro=Parados/Activos*100,Tasa_actividad=Activos/Total*100,
         Tasa_ocupacion=Ocupados/Total*100) %>% 
  mutate(
    Edad = str_replace(Edad, "De ", ""),
    Edad = str_replace(Edad, " a ", "-"),
    Edad = str_replace(Edad, " años", ""),
    Edad = str_replace(Edad, "70 y más", "70+"),
    
    Edad = factor(Edad, levels = c(
      "16-19", "20-24", "25-29", "30-34", "35-39", 
      "40-44", "45-49", "50-54", "55-59", "60-64", 
      "65-69", "70+"), ordered = T
      )
  )
```


Se comprueba que la limpieza esté bien hecha, primero viendo si el formato de los datos es el adecuado y asegurando que no quedan valores faltantes.


```{r,echo = FALSE}
write_csv(df_clean,file = "data/df_clean.csv")
```

# Análisis de las tasas

## Distribución de la tasa de actividad por sexo

```{r,echo = FALSE}
ggplot(df_clean, aes(x = Sexo, y = Tasa_actividad, fill = Sexo)) +
  geom_boxplot() +
  labs(
    title = "Distribución de la Tasa de Actividad por Sexo (Análisis Global)",
    subtitle = "El boxplot visualiza la mediana, la dispersión y la asimetría de la brecha.",
    y = "Tasa de Actividad (%)",
    x = NULL
  )  +
  theme_minimal()
```


## Evolucion de la tasa de paro por género y evolución de la brecha de la tasa de paro por género

En este bloque de código se construyen varias representaciones gráficas con el fin de analizar la evolución de la tasa de paro y la brecha de género a lo largo del tiempo. Para ello, se parte de una tabla en la que se calcula la variable *brecha_paro*, definida como la diferencia entre la tasa de paro de mujeres y la de hombres. Posteriormente, los datos se agrupan por periodo para obtener las tasas medias anuales de paro por sexo y la brecha media correspondiente. 


Agrupación de datos por periodo y por sexo
```{r, echo=FALSE}
# Calculamos la media de la tasa de actividad para cada grupo
# Usamos na.rm = TRUE para ignorar valores faltantes

df_p_sexo <- df_clean %>% group_by(Periodo, Sexo) %>% summarise(tasa_actividad = mean(Tasa_actividad, na.rm = TRUE) #Hay que ignorar los valores NA
                                                                , .groups = "drop") #hay que eliminar esas agrupaciones 

#Que pretendemos? Calcular la media de la tasa de actividad de todos los grupos del df



```

```{r, echo=FALSE}
# Gráfica 
ggplot(df_p_sexo, aes(x = Periodo, y = tasa_actividad, color = Sexo)) + geom_line(linewidth = 2) +  labs(title = "Tasa de actividad según sexo (2006–2024)", x = "Año", y = "% Tasa de actividad",color = "Sexo") + theme_minimal()  

# Eje X:Periodo -  Eje Y: tasa de actividad promedio


```


La gráfica enseña la evolución de la tasa de actividad en España entre los años 2006 y 2024, diferenciada por sexo. Por un lado, la proporción de hombres es mucho mayor a la de mujeres, cosa que va ligada a que los hombres siempre han tenido mayor participicaion en muchos mas sectores, como lo puede ser la construcción, y a que las mujeres se ligan mas al cuidado familiar.
    Pese a esto, la actividad masculina en 2008 se desacelera economicamnete, esto provocado por la crisis financiera que se vivió en la epoca. Es en 2017/18 que comienza su recuperación, pero nunca a los niveles previos a la crisis. En 2020, debido al Covid-19, se observa otra caida en la tendencía (porque el Covid-19 afectó a muchos sectores, como la industría por ejemplo). Aunque se observa también su recuperació, tampoco volvió a los nieveles previos de la crisis de 2008
    por el otro lado, la tasa de actividad femenina se muestra, en el periodo, ascendente ya que han ido incorporandose cada vez mas en el mercado laboral español




Tasa de actividad por edad y sexo

```{r, echo=FALSE}
# Agrupamos por Periodo, sexo y Edad

##Que pretendemos? Calcular la media de la tasa de actividad para cada combinación
df_sexo_edad <- df_clean %>% group_by(Periodo, Sexo, Edad) %>% summarise(tasa_actividad = mean(Tasa_actividad, na.rm = TRUE),.groups = "drop")

```

```{r, echo=FALSE}

ggplot(df_sexo_edad, aes(x = Periodo, y = tasa_actividad, color = Edad)) + geom_line(linewidth = 1) +  facet_wrap(~Sexo) + scale_x_continuous(breaks = seq(2006, 2024, by = 2)) + scale_y_continuous(labels = scales::comma) +  labs(title = "Tasa de actividad por edad y sexo (2006–2024)", x = "Año", y = "Tasa de actividad (%)", color = "Edad") + theme_minimal()  + theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10))

```
Como se observa en la gráfica, los hombres presentan tasas de actividad mucho más elevadas que las mujeres, sobretodo en el rango de 30 y 54 años. En ambos sexos, la tasa decae a partir de los 60 años, reflejando consigo la desigualdad en el mercado cuando se trata de envejecimiento



```{r, echo=FALSE}
df_paro_sexo <- df_clean %>% group_by(Periodo, Sexo) %>% summarise(tasa_paro = mean(Tasa_paro, na.rm = TRUE), .groups = "drop")

ggplot(df_paro_sexo, aes(x = Periodo, y = tasa_paro, color = Sexo)) + geom_line(size=2) + scale_x_continuous(breaks = seq(2006, 2024, by = 2))+ labs(title = "Tasa de paro por sexo (2006–2024)", x = "Año", y = "Tasa de paro (%)") + theme_minimal()

```
Desde la crisis de 2008, la tasa de paro en ambos sexos ha ido aumentado progresivamente hasta 2013, año en el que empezó a decaer. Lo que se observa, además, es como desde 2014 el paro en mujeres es mucho mas alto que el de hombres, reflejando la brecha persisitente.  Por tanto, aunque ambos sexos sufren paro, las mujeres tienen mas dificultades para acceder (o incluso mantenerse) a trabajos. 



El gráfico a continuación representa la evolución de la brecha de paro total.
```{r, echo=FALSE}
# 1º crear una tabla con la variable brecha_paro 
brecha <- df_clean %>% 
  select(Periodo, Edad,Sexo,Tasa_paro) %>% 
  pivot_wider(names_from = Sexo, values_from = Tasa_paro) %>% 
  mutate(brecha_paro=Mujeres-Hombres)


#2º Agrupar esas fechas por periodo, para asi no diferenciar entre grupos de edades y tener la brecha total
brechas_total <- brecha %>%
  group_by(Periodo) %>%
  summarise(
    tasa_hombres = mean(Hombres, na.rm = TRUE),
    tasa_mujeres = mean(Mujeres, na.rm = TRUE),
    brecha_paro_total = mean(brecha_paro, na.rm = TRUE)
  )


evo_brecha_total <- ggplot(brechas_total,aes(x=Periodo,y=brecha_paro_total)) + geom_line()+geom_point()+labs(title = "Evolución de la brecha de paro total",x="años",y="Brecha de tasa de paro")
evo_brecha_total

```
El gráfico previo representa la evolución de la brecha de paro total. En él se observa cómo la diferencia entre hombres y mujeres en la tasa de paro varía a lo largo del tiempo, con un aumento notable en los años posteriores a la crisis de 2008 y una ligera reducción en la última etapa analizada. 

## Evolucion de la tasa de paro y su brecha por grupo de edad


```{r, echo=FALSE}
brecha_edades <- df_clean %>% 
  select(Sexo, Edad, Periodo,Tasa_paro) %>% 
  pivot_wider(names_from = Sexo, values_from = Tasa_paro) %>% 
  mutate(brecha_paro=Mujeres-Hombres)

```

## Gráfica de Barras comparación grupos de edades con mayor brecha en 2006 y en 2024

En este apartado se elaboran una serie de gráficos de barras destinados a analizar la evolución de la brecha de paro por grupos de edad a lo largo del tiempo. En cada uno de ellos, las barras representan la magnitud de la brecha en los distintos grupos de edad, mientras que la línea discontinua negra indica la media general de la brecha para ese año.

```{r, echo=FALSE}

a1<- brecha_edades %>% filter(Periodo %in% 2024)

library(ggplot2)
library(dplyr)

rango_y <- range(brecha_edades$brecha_paro)
años<- unique(df_clean$Periodo)

# Definir los años que quieres graficar
años <- c(2024, 2020, 2010, 2007, 2006)

# Calcular rango del eje Y (opcional, si ya lo tienes definido)
rango_y <- range(brecha_edades$brecha_paro, na.rm = TRUE)

# Generar gráficos solo para esos años
graficos_brecha_paro <- lapply(años, function(año) {
  brecha_edades %>%
    filter(Periodo == año) %>%
    ggplot(aes(x = factor(Edad, levels = unique(Edad)), y = brecha_paro)) +
    geom_col(fill = "steelblue") +
    ylim(rango_y) +
    labs(
      title = paste("Brecha de paro por grupo de edad"),
      x = "Grupo de edad",
      y = "Brecha (%)"
    ) +
    geom_hline(
      yintercept = mean(brecha_edades$brecha_paro[brecha_edades$Periodo == año], na.rm = TRUE),
      color = "grey10",
      linetype = "dashed",
      linewidth = 1
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size=8,face="bold"),
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.margin = margin(15, 30, 15, 30)  # <-- añade espacio alrededor del gráfico
    )
})

library(cowplot)

plot_grid(
  plotlist = graficos_brecha_paro[1:4],
  ncol = 2,
  labels = c("2024", "2023", "2010", "2007")  # opcional
)
```
Los gráficos resultantes muestran, de forma clara, cómo la intensidad de la brecha de género en el desempleo varía según la edad y el momento temporal. En los primeros años analizados, la brecha es especialmente elevada entre los jóvenes, lo que evidencia una mayor vulnerabilidad del empleo femenino en los jóvenes. En cambio, en los años más recientes para esos tramos de edad, las diferencias tienden a moderarse y presentan un patrón más equilibrado entre grupos, aunque persisten desigualdades estructurales en los segmentos de mayor edad y los más jóvenes.

Este bloque  busca ofrecer una visión desagregada y evolutiva de la brecha de paro por edad. Gracias a la representación mediante diagramas de barras, se facilita la comparación entre grupos generacionales y se identifican con claridad los grupos que más contribuyen a mantener las disparidades laborales entre hombres y mujeres a lo largo del tiempo.


```{r, echo=FALSE}
brecha_relativa <- df_clean %>%
  group_by(Periodo, Sexo) %>%
  summarise(Tasa = mean(Tasa_actividad, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = Sexo, values_from = Tasa) %>%
  mutate(Razon = Hombres / Mujeres)
```

```{r, echo=FALSE}
ggplot(brecha_relativa, aes(x = Periodo, y = Razon)) +
  geom_line(color = "blue", linewidth = 1.2) +
  geom_point(color = "red", size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "gray") +  # línea de igualdad
  scale_y_continuous(breaks = seq(1, 1.5, by = 0.05)) +  # marcas cada 0.05
  scale_x_continuous(breaks = seq(2006, 2024, by = 2)) +  # años cada 2
  labs(
    title = "Evolución de la razón Hombres/Mujeres",
    x = "Año",
    y = "Razón (Hombres / Mujeres)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold")
  )
```
Esta gráfica muestra cómo ha cambiado la relación entre la tasa de actividad de los hombres y la de las mujeres a lo largo del tiempo. Cada punto representa el cociente entre ambas tasas en un año determinado. Una razón superior a 1 indica que los hombres tienen mayor participación en el mercado laboral que las mujeres. Desde 2006, la razón ha descendido de forma sostenida, lo que refleja una reducción progresiva de la brecha de género. Aunque no se ha alcanzado la igualdad, las mujeres han incrementado su participación relativa. El pequeño repunte en 2024 sugiere una posible ralentización en esa convergencia o una proyección conservadora.


<!-- # ```{r} -->
<!-- # # Filtrar para excluir el grupo de edad "70 y más años" -->
<!-- # brecha_edad_filtrada <- df_clean %>% filter(Edad != "70 y más años") -->
<!-- #  -->
<!-- # # Graficar la razón Hombres/Mujeres por edad (sin el grupo de 70) -->
<!-- # ggplot(brecha_edad_filtrada, aes(x = Periodo, y = Razon, color = Edad)) + -->
<!-- #   geom_line(linewidth = 1) + -->
<!-- #   geom_hline(yintercept = 1, linetype = "dashed", color = "gray") + -->
<!-- #   scale_y_continuous(breaks = seq(0.5, 2, by = 0.1)) + -->
<!-- #   scale_x_continuous(breaks = seq(2006, 2024, by = 2)) + -->
<!-- #   labs( -->
<!-- #     title = "Razón Hombres/Mujeres en la tasa de actividad por edad (sin 70+)", -->
<!-- #     x = "Año", -->
<!-- #     y = "Razón (Hombres / Mujeres)", -->
<!-- #     color = "Edad" -->
<!-- #   ) + -->
<!-- #   theme_minimal() + -->
<!-- #   theme(axis.text.x = element_text(angle = 45, hjust = 1)) -->
<!-- #  -->
<!-- #  -->
<!-- # ``` -->


# Distribución de la población en el mercado laboral

## Composición del mercado laboral 

En el siguiente gráfico se muestra la composición del mercado laboral, separando entre: Parados,Ocupados e Inactivos para cada grupo de edad, separado por sexo.

```{r, echo=FALSE}

datos_composicion<- df_clean  %>% 
  select(Periodo,Edad,Sexo,Activos,Ocupados,Parados,Inactivos) %>% 
  pivot_longer(cols = c(Inactivos,Ocupados,Parados),names_to = "Estado",values_to = "N_Personas")

años1 <- c(2024, 2006)

graficos_composicion_por_año <- lapply(años1, function(año) {
  datos_composicion %>%
    filter(Periodo == año) %>%
    ggplot(aes(
      x = factor(Edad, levels = unique(Edad)),
      y = N_Personas,
      fill = Estado
    )) +
    geom_col(position = "fill") +
    labs(
      title = paste("Composición del mercado laboral por grupo de edad -", año),
      x = "Grupo de edad",
      y = "Proporción",
      fill = "Estado"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.margin = margin(15, 30, 15, 30)  # ← más espacio alrededor del gráfico
    ) +
    facet_wrap(~Sexo) # Añadir o quitar según quieras comparar hombres y mujeres
})

graficos_composicion_por_año


```
Del análisis de los gráficos se observa una estructura bastante estable del mercado laboral por edad y sexo a lo largo del tiempo, con ligeras variaciones asociadas a los ciclos económicos. En ambos sexos, el grupo central de edad (30-54 años) concentra la mayor proporción de personas ocupadas, mientras que los extremos —jóvenes y mayores— presentan una mayor presencia de inactivos. Las mujeres muestran sistemáticamente una menor proporción de ocupación y una mayor de inactividad en comparación con los hombres, aunque esta diferencia tiende a reducirse en los años más recientes. Asimismo, la proporción de personas paradas es más significativa en los grupos jóvenes, reflejando una mayor vulnerabilidad del empleo juvenil. En conjunto, los gráficos ponen de manifiesto que, pese a los avances en participación femenina y la estabilidad general del empleo en edades medias, persisten desigualdades de género e importantes diferencias intergeneracionales dentro del mercado laboral.

Estas gráficas, también ponen de manifiesto un proceso de envejecimiento del desempleo y una convergencia progresiva entre hombres y mujeres en la estructura interna del paro, aunque todavía persisten diferencias derivadas de los roles laborales y sociales tradicionales. Mientras los hombres mayores ganan peso dentro del paro total por el retraso en la jubilación, las mujeres siguen mostrando una mayor vulnerabilidad en las edades centrales, reflejando las desigualdades de género que aún caracterizan el mercado laboral español.



  




# act inact

AQUI HAY QUE CALCULAR EL COCIENTE ENTRE ACTIVOS E INACTIVOS

<!-- ```{r, echo=FALSE} -->
<!-- df_act_inact <- df_clean %>% -->
<!--   group_by(Sexo) %>% -->
<!--   summarise( -->
<!--     Activos = sum(Activos, na.rm = TRUE), -->
<!--     Inactivos = sum(Inactivos, na.rm = TRUE) -->
<!--   ) %>% -->
<!--   pivot_longer(cols = c(Activos, Inactivos), names_to = "Situacion", values_to = "Personas") -->

<!-- ggplot(df_act_inact, aes(x = Sexo, y = Personas, fill = Situacion)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs( -->
<!--     title = "Distribución de activos e inactivos por sexo", -->
<!--     x = "Sexo", -->
<!--     y = "Personas", -->
<!--     fill = "Situación" -->
<!--   ) + -->
<!--   theme_minimal() -->

<!-- ```  -->




# Resultados


## desv est y varianza
```{r, echo=FALSE}
df_clean %>% group_by(Sexo) %>% summarise(sd_ocupados = sd(Ocupados, na.rm = TRUE),var_ocupados = var(Ocupados, na.rm = TRUE))

```

```{r, echo=FALSE}
df_clean %>%
  group_by(Sexo) %>%
  summarise(media_ocupados = mean(Ocupados, na.rm = TRUE),
            media_inactivos = mean(Inactivos, na.rm = TRUE)) %>%
  summarise(brecha_ocup = diff(media_ocupados),
            brecha_inact = diff(media_inactivos))

```


```{r,echo = FALSE}
edades_focales <- c(
  "25-29",
  "30-34",
  "35-39",
  "40-44",
  "45-49",
  "50-54"
)
t.test(Tasa_ocupacion ~ Sexo, data = df_clean%>% filter(Periodo == 2024,Edad%in%edades_focales))
```


# Conclusión